# Configuracao do framework topsys.

JNDI.CONNECTION java:comp/env/jdbc/ZapeatSiteDS

CLASS.BROKER.IMPL br.com.topsys.database.jdbc.TSDataBaseBrokerImpl

CLASS.SEQUENCE.IMPL br.com.topsys.database.jdbc.sequence.TSSequencePostgresImpl

CODIGO.UNIQUE 23505

CODIGO.FOREIGNKEY 23503

#ComentarioDAO
comentariodao.inserir=INSERT INTO PUBLIC.COMENTARIOS (USUARIO_ID, FORNECEDOR_ID, DESCRICAO, DATA_CADASTRO, FLAG_INDICA_ATENDIMENTO, FLAG_INDICA_PROMOCAO) VALUES (?, ?, ?, CURRENT_TIMESTAMP, ?, ?)
comentariodao.obterIndicacaoEstabelecimento=SELECT C.ID, C.DESCRICAO, US.NOME, F.ID, F.NOME_FANTASIA, F.LOGOMARCA FROM COMENTARIOS C, USUARIOS_SITE US, FORNECEDORES F WHERE C.USUARIO_ID = US.ID AND C.FORNECEDOR_ID = F.ID AND C.FLAG_INDICA_ATENDIMENTO AND F.FLAG_ATIVO ORDER BY RANDOM() LIMIT 1
comentariodao.rankingEstabelecimento=SELECT POSICAO_RANK, A.ID FROM (SELECT RANK() OVER (ORDER BY F.ID DESC) AS POSICAO_RANK, F.ID FROM COMENTARIOS C, FORNECEDORES F WHERE C.FORNECEDOR_ID = F.ID AND F.FLAG_ATIVO GROUP BY F.ID, F.NOME_FANTASIA) AS A WHERE ID = ?

#FornecedorDAO
fornecedordao.obter=SELECT F.ID, F.RAZAO_SOCIAL, F.CNPJ, F.NOME_FANTASIA, F.CEP, F.LOGRADOURO, F.NUMERO, F.BAIRRO, F.CIDADE_ID, F.LATITUDE, F.LONGITUDE, F.LOGOMARCA, F.FLAG_ATIVO, F.DESCRICAO, F.HORARIOS_FUNCIONAMENTO, F.TWITTER, F.FACEBOOK, F.SITE, F.TELEFONE, SUM(CASE WHEN C.FLAG_INDICA_ATENDIMENTO THEN 1 ELSE 0 END + CASE WHEN C.FLAG_INDICA_PROMOCAO THEN 1 ELSE 0 END) AS TOTAL FROM PUBLIC.FORNECEDORES F, COMENTARIOS C WHERE F.ID = C.FORNECEDOR_ID AND F.ID = ? AND F.FLAG_ATIVO GROUP BY F.ID,F.RAZAO_SOCIAL, F.CNPJ, F.NOME_FANTASIA, F.CEP, F.LOGRADOURO, F.NUMERO, F.BAIRRO, F.CIDADE_ID, F.LATITUDE, F.LONGITUDE, F.LOGOMARCA, F.FLAG_ATIVO, F.DESCRICAO, F.HORARIOS_FUNCIONAMENTO, F.TWITTER, F.FACEBOOK, F.SITE, F.TELEFONE
fornecedordao.pesquisarHome=SELECT ID, LOGOMARCA, NOME_FANTASIA FROM PUBLIC.FORNECEDORES ORDER BY RANDOM() LIMIT 6
fornecedordao.pesquisarTopGeral=SELECT F.ID, F.NOME_FANTASIA, SUM(CASE WHEN FLAG_INDICA_ATENDIMENTO THEN 1 ELSE 0 END + CASE WHEN FLAG_INDICA_PROMOCAO THEN 1 ELSE 0 END) TOTAL FROM PUBLIC.COMENTARIOS C, FORNECEDORES F WHERE C.FORNECEDOR_ID = F.ID GROUP BY F.ID, F.NOME_FANTASIA ORDER BY TOTAL DESC LIMIT 5
fornecedordao.pesquisarMelhorAtendimento=SELECT F.ID, F.NOME_FANTASIA, SUM(CASE WHEN FLAG_INDICA_ATENDIMENTO THEN 1 ELSE 0 END) TOTAL, F.LOGOMARCA FROM PUBLIC.COMENTARIOS C, FORNECEDORES F, FORNECEDORES_CATEGORIAS FC WHERE C.FORNECEDOR_ID = F.ID AND FC.FORNECEDOR_ID = F.ID AND FC.CATEGORIA_ID = ? GROUP BY F.ID, F.NOME_FANTASIA, F.LOGOMARCA ORDER BY TOTAL DESC LIMIT 5
fornecedordao.pesquisarMelhorComida=SELECT F.ID, F.NOME_FANTASIA, SUM(CASE WHEN FLAG_INDICA_PROMOCAO THEN 1 ELSE 0 END) TOTAL, F.LOGOMARCA FROM PUBLIC.COMENTARIOS C, FORNECEDORES F, FORNECEDORES_CATEGORIAS FC WHERE C.FORNECEDOR_ID = F.ID AND FC.FORNECEDOR_ID = F.ID AND FC.CATEGORIA_ID = ? GROUP BY F.ID, F.NOME_FANTASIA, F.LOGOMARCA ORDER BY TOTAL DESC LIMIT 5

#ImagemFornecedorDAO
imagemfornecedordao.pesquisar=SELECT ID, FORNECEDOR_ID, IMAGEM FROM IMAGENS_FORNECEDORES WHERE FORNECEDOR_ID = ? ORDER BY ID DESC LIMIT 3

#PromocaoDAO
promocaodao.pesquisarporindicacoes=SELECT P.ID, P.TIPO_PROMOCAO_ID, TP.DESCRICAO, P.FORNECEDOR_ID, F.NOME_FANTASIA, F.LOGOMARCA, F.TELEFONE, F.SITE, CAT.ID, CAT.DESCRICAO, P.DESCRICAO, P.TITULO, (SELECT COUNT(*) FROM COMENTARIOS C WHERE C.FORNECEDOR_ID = F.ID AND C.FLAG_INDICA_PROMOCAO AND C.FLAG_INDICA_ATENDIMENTO) AS INDICACOES FROM PROMOCOES P INNER JOIN TIPOS_PROMOCOES TP ON TP.ID = P.TIPO_PROMOCAO_ID INNER JOIN FORNECEDORES F ON P.FORNECEDOR_ID = F.ID INNER JOIN FORNECEDORES_CATEGORIAS FC ON FC.FORNECEDOR_ID = F.ID INNER JOIN CATEGORIAS CAT ON CAT.ID = FC.CATEGORIA_ID AND FC.PRIORIDADE = 1 WHERE TP.ID = COALESCE(?, TP.ID) AND FC.CATEGORIA_ID = COALESCE(?, FC.CATEGORIA_ID) ORDER BY INDICACOES DESC LIMIT 6 OFFSET(COALESCE(?, 1) - 1) * 6
promocaodao.pesquisarqtdpaginasporindicacoes=SELECT CASE WHEN MOD(COUNT(*) ,6) > 0 THEN COUNT(*)/6+1 ELSE COUNT(*)/6 END FROM PROMOCOES P INNER JOIN TIPOS_PROMOCOES TP ON TP.ID = P.TIPO_PROMOCAO_ID INNER JOIN FORNECEDORES F ON P.FORNECEDOR_ID = F.ID INNER JOIN FORNECEDORES_CATEGORIAS FC ON FC.FORNECEDOR_ID = F.ID INNER JOIN CATEGORIAS CAT ON CAT.ID = FC.CATEGORIA_ID AND FC.PRIORIDADE = 1 WHERE TP.ID = COALESCE(?, TP.ID) AND FC.CATEGORIA_ID = COALESCE(?, FC.CATEGORIA_ID)
promocaodao.obterPromocaoHora=SELECT P.ID, P.TIPO_PROMOCAO_ID, TP.DESCRICAO, P.FORNECEDOR_ID, F.NOME_FANTASIA, P.DESCRICAO, P.INICIO, P.FIM, P.PRECO_ORIGINAL, P.PRECO_PROMOCIONAL, P.TITULO, F.LONGITUDE, F.LATITUDE FROM PUBLIC.PROMOCOES P, TIPOS_PROMOCOES TP, FORNECEDORES F WHERE P.TIPO_PROMOCAO_ID = TP.ID AND P.FORNECEDOR_ID = F.ID AND P.TIPO_PROMOCAO_ID = 1 AND CURRENT_DATE BETWEEN DATE_TRUNC ('DAY', P.INICIO) AND DATE_TRUNC('DAY', P.FIM) ORDER BY RANDOM() LIMIT 1
promocaodao.pesquisarPromocoesHora=SELECT P.ID, P.TIPO_PROMOCAO_ID, TP.DESCRICAO, P.FORNECEDOR_ID, F.NOME_FANTASIA, P.DESCRICAO, P.INICIO, P.FIM, P.PRECO_ORIGINAL, P.PRECO_PROMOCIONAL, P.TITULO, F.LONGITUDE, F.LATITUDE, F.SITE, (SELECT COUNT(*) FROM COMENTARIOS C WHERE C.PROMOCAO_ID = P.ID AND C.FLAG_INDICA_PROMOCAO AND C.FLAG_INDICA_PROMOCAO) AS INDICACOES, F.TELEFONE FROM PUBLIC.PROMOCOES P, TIPOS_PROMOCOES TP, FORNECEDORES F WHERE P.TIPO_PROMOCAO_ID = TP.ID AND P.FORNECEDOR_ID = F.ID AND P.TIPO_PROMOCAO_ID = 1 AND CURRENT_DATE BETWEEN DATE_TRUNC ('DAY', P.INICIO) AND DATE_TRUNC('DAY', P.FIM) ORDER BY RANDOM()
promocaodao.obterPromocaoDia=SELECT P.ID, P.TIPO_PROMOCAO_ID, TP.DESCRICAO, P.FORNECEDOR_ID, F.NOME_FANTASIA, P.DESCRICAO, P.INICIO, P.FIM, P.PRECO_ORIGINAL, P.PRECO_PROMOCIONAL, P.TITULO, (SELECT IMAGEM FROM IMAGENS_PROMOCOES IP WHERE IP.PROMOCAO_ID = P.ID ORDER BY RANDOM() LIMIT 1), F.LONGITUDE, F.LATITUDE FROM PUBLIC.PROMOCOES P, TIPOS_PROMOCOES TP, FORNECEDORES F WHERE P.TIPO_PROMOCAO_ID = TP.ID AND P.FORNECEDOR_ID = F.ID AND P.TIPO_PROMOCAO_ID = 2 AND DATE_TRUNC ('DAY', P.INICIO) = CURRENT_DATE AND P.FORNECEDOR_ID = COALESCE(?, P.FORNECEDOR_ID) AND P.FORNECEDOR_ID > 0 ORDER BY RANDOM() LIMIT 1
promocaodao.obterPromocaoSemana=SELECT P.ID, P.TIPO_PROMOCAO_ID, TP.DESCRICAO, P.FORNECEDOR_ID, F.NOME_FANTASIA, P.DESCRICAO, P.INICIO, P.FIM, P.PRECO_ORIGINAL, P.PRECO_PROMOCIONAL, P.TITULO, (SELECT IMAGEM FROM IMAGENS_PROMOCOES IP WHERE IP.PROMOCAO_ID = P.ID ORDER BY RANDOM() LIMIT 1), F.LONGITUDE, F.LATITUDE FROM PUBLIC.PROMOCOES P, TIPOS_PROMOCOES TP, FORNECEDORES F WHERE P.TIPO_PROMOCAO_ID = TP.ID AND P.FORNECEDOR_ID = F.ID AND P.TIPO_PROMOCAO_ID = 3 AND CURRENT_DATE BETWEEN DATE_TRUNC ('DAY', P.INICIO) AND DATE_TRUNC('DAY', P.FIM) AND P.FORNECEDOR_ID = COALESCE(?, P.FORNECEDOR_ID) AND P.FORNECEDOR_ID > 0 ORDER BY RANDOM() LIMIT 1
promocaodao.obter=SELECT P.ID, P.TIPO_PROMOCAO_ID, TP.DESCRICAO, P.FORNECEDOR_ID, F.NOME_FANTASIA, F.LOGOMARCA, F.HORARIOS_FUNCIONAMENTO, F.LOGRADOURO, F.NUMERO, F.BAIRRO, F.TELEFONE, CAT.ID, CAT.DESCRICAO, CAT.CSS, (SELECT IMAGEM FROM IMAGENS_PROMOCOES IP WHERE IP.PROMOCAO_ID = P.ID ORDER BY RANDOM() LIMIT 1), P.DESCRICAO, P.INICIO, P.FIM, P.PRECO_ORIGINAL, P.PRECO_PROMOCIONAL, P.TITULO, F.LONGITUDE, F.LATITUDE FROM PUBLIC.PROMOCOES P INNER JOIN TIPOS_PROMOCOES TP ON TP.ID = P.TIPO_PROMOCAO_ID INNER JOIN FORNECEDORES F ON F.ID = P.FORNECEDOR_ID INNER JOIN FORNECEDORES_CATEGORIAS FC ON FC.FORNECEDOR_ID = F.ID AND FC.PRIORIDADE = 1 INNER JOIN CATEGORIAS CAT ON CAT.ID = FC.CATEGORIA_ID WHERE P.ID = COALESCE(?, (SELECT ID FROM PROMOCOES P1 WHERE CURRENT_DATE BETWEEN P1.INICIO AND P1.FIM ORDER BY RANDOM() LIMIT 1)) 

#UsuarioDAO
usuariodao.inserir=INSERT INTO PUBLIC.USUARIOS_SITE (NOME, EMAIL, SENHA, FLAG_ATIVO, IMAGEM) VALUES (?, ?, ?, ?, ?)
usuariodao.obter=SELECT ID, NOME, EMAIL, SENHA, FLAG_ATIVO, IMAGEM FROM PUBLIC.USUARIOS_SITE WHERE EMAIL = ?

#BuscaDAO
buscadao.pesquisarportexto=SELECT * FROM FC_BUSCAR(?) LIMIT 6 OFFSET(COALESCE(?, 1) - 1) * 6
buscadao.obterqtdpaginasportexto=SELECT CASE WHEN MOD(COUNT(*) ,6) > 0 THEN COUNT(*)/6+1 ELSE COUNT(*)/6 END FROM FC_BUSCAR(?)
buscadao.pesquisarpromocaoportexto=SELECT DISTINCT P.TITULO, F.RAZAO_SOCIAL, P.DESCRICAO, 2, CAT.DESCRICAO, F.TELEFONE, F.SITE, (SELECT COUNT(*) FROM COMENTARIOS C WHERE C.FORNECEDOR_ID = P.ID AND C.FLAG_INDICA_PROMOCAO AND C.FLAG_INDICA_ATENDIMENTO) AS INDICACOES FROM PROMOCOES P INNER JOIN FORNECEDORES F ON F.id = P.FORNECEDOR_ID INNER JOIN FORNECEDORES_CATEGORIAS FC ON FC.FORNECEDOR_ID = F.ID AND FC.PRIORIDADE = 1 INNER JOIN CATEGORIAS CAT ON FC.CATEGORIA_ID = CAT.ID WHERE F.DESCRICAO ILIKE COALESCE(?, F.DESCRICAO)
buscadao.pesquisarcarrochefeportexto=SELECT DISTINCT CC.TITULO, F.RAZAO_SOCIAL, CC.DESCRICAO, 2, CAT.DESCRICAO, F.TELEFONE, F.SITE FROM CARROS_CHEFES CC INNER JOIN FORNECEDORES F ON F.ID = CC.FORNECEDOR_ID INNER JOIN FORNECEDORES_CATEGORIAS FC ON FC.FORNECEDOR_ID = F.ID AND FC.PRIORIDADE = 1 INNER JOIN CATEGORIAS CAT ON FC.CATEGORIA_ID = CAT.ID WHERE CC.DESCRICAO ILIKE COALESCE(?, CC.DESCRICAO)
buscadao.pesquisarestabelecimentoportexto=SELECT DISTINCT F.RAZAO_SOCIAL, F.LOGRADOURO || ', ' || F.BAIRRO, F.DESCRICAO, 1, CAT.DESCRICAO, F.TELEFONE, F.SITE, (SELECT COUNT(*) FROM COMENTARIOS C WHERE C.FORNECEDOR_ID = P.ID AND C.FLAG_INDICA_PROMOCAO AND C.FLAG_INDICA_ATENDIMENTO) AS INDICACOES FROM FORNECEDORES F INNER JOIN FORNECEDORES_CATEGORIAS FC ON FC.FORNECEDOR_ID = F.ID INNER JOIN CATEGORIAS CAT ON FC.CATEGORIA_ID = CAT.ID AND FC.PRIORIDADE = 1 LEFT OUTER JOIN PROMOCOES P ON P.FORNECEDOR_ID = F.ID WHERE F.DESCRICAO ILIKE COALESCE(?, F.DESCRICAO)

#CidadeDAO
cidadedao.pesquisar=SELECT ID, NOME FROM CIDADES WHERE NOME ILIKE COALESCE(?, NOME)
cidadedao.obter=SELECT ID, NOME FROM CIDADES WHERE ID = ?

#CarroChefeDAO
carrochefedao.pesquisaporcategoria=SELECT CC.ID, CC.FORNECEDOR_ID, F.NOME_FANTASIA, F.LOGOMARCA, F.TELEFONE, F.SITE, CAT.ID, CAT.DESCRICAO, CC.DESCRICAO, CC.TITULO FROM CARROS_CHEFES CC INNER JOIN FORNECEDORES F ON CC.FORNECEDOR_ID = F.ID INNER JOIN FORNECEDORES_CATEGORIAS FC ON FC.FORNECEDOR_ID = F.ID INNER JOIN CATEGORIAS CAT ON CAT.ID = FC.CATEGORIA_ID AND FC.PRIORIDADE = 1 WHERE FC.CATEGORIA_ID = COALESCE(?, FC.CATEGORIA_ID) ORDER BY CC.TITULO DESC LIMIT 6 OFFSET(COALESCE(?, 1) - 1) * 6
carrochefedao.pesquisarqtdpaginasporcategoria=SELECT CASE WHEN MOD(COUNT(*) ,6) > 0 THEN COUNT(*)/6+1 ELSE COUNT(*)/6 END FROM CARROS_CHEFES CC INNER JOIN FORNECEDORES F ON CC.FORNECEDOR_ID = F.ID INNER JOIN FORNECEDORES_CATEGORIAS FC ON FC.FORNECEDOR_ID = F.ID INNER JOIN CATEGORIAS CAT ON CAT.ID = FC.CATEGORIA_ID AND FC.PRIORIDADE = 1 WHERE FC.CATEGORIA_ID = COALESCE(?, FC.CATEGORIA_ID)

#CategoriaDAO
categoriadao.obter=SELECT ID, DESCRICAO, CSS FROM CATEGORIAS WHERE ID = ?

#BannerDAO
bannerdao.obterbannersuperiorgrande=SELECT B.ID, B.IMAGEM FROM BANNERS B WHERE B.FLAG_ATIVO AND B.TIPO_BANNER_ID = 1 AND CURRENT_DATE BETWEEN B.INICIO AND B.FIM ORDER BY B.TAXA_PRIORIDADE ASC, RANDOM() LIMIT 1
bannerdao.obterbannersuperiorpequeno=SELECT B.ID, B.IMAGEM FROM BANNERS B WHERE B.FLAG_ATIVO AND B.TIPO_BANNER_ID = 2 AND CURRENT_DATE BETWEEN B.INICIO AND B.FIM ORDER BY B.TAXA_PRIORIDADE ASC, RANDOM() LIMIT 1
bannerdao.obterbannerlateral=SELECT B.ID, B.IMAGEM FROM BANNERS B WHERE B.FLAG_ATIVO AND B.TIPO_BANNER_ID = 3 AND CURRENT_DATE BETWEEN B.INICIO AND B.FIM ORDER BY B.TAXA_PRIORIDADE ASC, RANDOM() LIMIT 1

